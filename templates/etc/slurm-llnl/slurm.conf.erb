# slurm.conf file generated by configurator.html.
# Put this file on all nodes of your cluster.
# See the slurm.conf man page for more information.

ClusterName=<%= @ClusterName %>

ControlMachine=<%= @ControlMachine %>
#ControlAddr=
#BackupController=
#BackupAddr=

AuthType=auth/munge
CacheGroups=0
CryptoType=crypto/munge
DisableRootJobs=YES
#EnforcePartLimits=NO

CheckpointType=checkpoint/none
JobCheckpointDir=/var/spool/slurm-llnl/checkpoint

<% if @Prolog != '' %>Prolog=<%= @Prolog %><% else %>#Prolog unset <% end %>
<% if @Epilog != '' %>Epilog=<%= @Epilog %><% else %>#Epilog unset <% end %>

<% if @TaskProlog != '' %>TaskProlog=<%= @TaskProlog %><% else %>#TaskProlog unset <% end %>
<% if @TaskEpilog != '' %>TaskEpilog=<%= @TaskEpilog %><% else %>#TaskEpilog unset <% end %>

<% if @PrologSlurmctld != '' %>PrologSlurmctld=<%= @PrologSlurmctld %><% else %>#PrologSlurmctld unset <% end %>
<% if @EpilogSlurmctld != '' %>Epilog=Slurmctld<%= @EpilogSlurmctld %><% else %>#EpilogSlurmctld unset <% end %>

FirstJobId=19000000
#GresTypes=
GroupUpdateForce=600
#GroupUpdateTime=600
#JobFileAppend=0
JobRequeue=0
<% if @JobSubmitPlugins != '' %>JobSubmitPlugins=<%= @JobSubmitPlugins %><% else %>#JobSubmitPlugins unset <% end %>
#KillOnBadExit=0
#Licenses=foo*4,bar
#MailProg=/bin/mail
MaxJobCount=15000
#MaxTasksPerNode=128
MpiDefault=openmpi
MpiParams=ports=12000-12999
#PluginDir=
#PlugStackConfig=
#PrivateData=jobs
ProctrackType=proctrack/linuxproc
#PropagatePrioProcess=0
PropagateResourceLimits=NONE
#PropagateResourceLimitsExcept=
ReturnToService=2
#SallocDefaultCommand=

SlurmctldPidFile=/var/run/<%= @service %>/slurmctld.pid
SlurmctldPort=6817

# Use "%n" with multiple nodes per host
# SlurmdPidFile=/var/run/<%= @service %>/slurmd.%n.pid
SlurmdPidFile=/var/run/<%= @service %>/slurmd.%n.pid
SlurmdPort=6818

# Use "%n" with multiple nodes per host
# SlurmdSpoolDir=/var/tmp/slurmd/%n
SlurmdSpoolDir=/var/tmp/slurmd

SlurmUser=slurm
#SrunEpilog=
#SrunProlog=
StateSaveLocation=/var/spool/<%= @service %>/state
SwitchType=switch/none
TaskPlugin=task/none
#TaskPluginParam=
#TopologyPlugin=topology/tree
TmpFs=/loc
#TrackWCKey=no
#TreeWidth=
#UnkillableStepProgram=
#UsePAM=0
#
# TIMERS
#BatchStartTimeout=10
#CompleteWait=0
#EpilogMsgTime=2000
#GetEnvTimeout=2
#HealthCheckInterval=0
#HealthCheckProgram=
InactiveLimit=0
KillWait=30
MessageTimeout=45
#ResvOverRun=0
MinJobAge=300
OverTimeLimit=2160

SlurmctldTimeout=300
SlurmdTimeout=120
#UnkillableStepTimeout=60
#VSizeFactor=0
Waittime=0
#
# SCHEDULING
#DefMemPerCPU=0
#MaxMemPerCPU=0
#SchedulerRootFilter=1
#SchedulerTimeSlice=30
# FastSchedule=2 for testing purposes only
FastSchedule=0
#
#
SchedulerType=sched/backfill
SchedulerParameters=default_queue_depth=1000,bf_continue,bf_interval=360,bf_max_job_user=100,bf_resolution=600,bf_window=4320,bf_max_job_part=1000,max_job_bf=300,defer

SelectType=select/cons_res
SelectTypeParameters=CR_Core

PreemptType=preempt/partition_prio
PreemptMode=Cancel

#
# JOB PRIORITY
PriorityType=priority/multifactor
PriorityDecayHalfLife=1-00:00:00
#PriorityCalcPeriod=
#PriorityFavorSmall=
PriorityMaxAge=1-00:00:00
#PriorityUsageResetPeriod=
PriorityWeightAge=1000
PriorityWeightFairshare=10000
PriorityWeightPartition=10000
#PriorityWeightJobSize=
#PriorityWeightQOS=10000
#
# LOGGING AND ACCOUNTING
AccountingStorageEnforce=limits,qos
AccountingStorageHost=<%= @ControlMachine %>
AccountingStorageType=accounting_storage/slurmdbd

JobAcctGatherFrequency=60
JobAcctGatherType=jobacct_gather/linux

DebugFlags=NO_CONF_HASH
SlurmctldDebug=3
SlurmctldLogFile=/var/log/<%= @service %>/slurmctld.log
SlurmdDebug=3
SlurmdLogFile=/var/log/slurmd.%n.log
SlurmSchedLogFile=/var/log/<%= @service %>/slurmsched.log
SlurmSchedLogLevel=0
#

<% @partitions.values.each do |partition| -%>
<% if partition['PartitionName'] != nil -%>PartitionName=<%= partition['PartitionName']-%><% end -%>
<% if partition['AllocNodes'] != nil -%> AllocNodes=<%= partition['AllocNodes'].join(",")-%><% end -%>
<% if partition['AllowAccounts'] != nil -%> AllowAccounts=<%= partition['AllowAccounts'].join(",")-%><% end -%>
<% if partition['AllowGroups'] != nil -%> AllowGroups=<%= partition['AllowGroups'].join(",")-%><% end -%>
<% if partition['AllowQos'] != nil -%> AllowQos=<%= partition['AllowQos'].join(",")-%><% end -%>
<% if partition['Alternate'] != nil -%> Alternate=<%= partition['Alternate']-%><% end -%>
<% if partition['Default'] != nil -%> Default=<%= partition['Default']-%><% end -%>
<% if partition['DefMemPerCPU'] != nil -%> DefMemPerCPU=<%= partition['DefMemPerCPU']-%><% end -%>
<% if partition['DefMemPerNode'] != nil -%> DefMemPerNode=<%= partition['DefMemPerNode']-%><% end -%>
<% if partition['DenyAccounts'] != nil -%> DenyAccounts=<%= partition['DenyAccounts'].join(",")-%><% end -%>
<% if partition['DenyQos'] != nil -%> DenyQos=<%= partition['DenyQos'].join(",")-%><% end -%>
<% if partition['DefaultTime'] != nil -%> DefaultTime=<%= partition['DefaultTime']-%><% end -%>
<% if partition['DisableRootJobs'] != nil -%> DisableRootJobs=<%= partition['DisableRootJobs']-%><% end -%>
<% if partition['GraceTime'] != nil -%> GraceTime=<%= partition['GraceTime']-%><% end -%>
<% if partition['Hidden'] != nil -%> Hidden=<%= partition['Hidden']-%><% end -%>
<% if partition['LLN'] != nil -%> LLN=<%= partition['LLN']-%><% end -%>
<% if partition['MaxCPUsPerNode'] != nil -%> MaxCPUsPerNode=<%= partition['MaxCPUsPerNode']-%><% end -%>
<% if partition['MaxMemPerCPU'] != nil -%> MaxMemPerCPU=<%= partition['MaxMemPerCPU']-%><% end -%>
<% if partition['MaxMemPerNode'] != nil -%> MaxMemPerNode=<%= partition['MaxMemPerNode']-%><% end -%>
<% if partition['MaxNodes'] != nil -%> MaxNodes=<%= partition['MaxNodes']-%><% end -%>
<% if partition['MaxTime'] != nil -%> MaxTime=<%= partition['MaxTime']-%><% end -%>
<% if partition['MinNodes'] != nil -%> MinNodes=<%= partition['MinNodes']-%><% end -%>
<% if partition['Nodes'] != nil -%> Nodes=<%= partition['Nodes'].join(",")-%><% end -%>
<% if partition['PreemptMode'] != nil -%> PreemptMode=<%= partition['PreemptMode']-%><% end -%>
<% if partition['Priority'] != nil -%> Priority=<%= partition['Priority']-%><% end -%>
<% if partition['QOS'] != nil -%> QOS=<%= partition['QOS']-%><% end -%>
<% if partition['ReqResv'] != nil -%> ReqResv=<%= partition['ReqResv']-%><% end -%>
<% if partition['RootOnly'] != nil -%> RootOnly=<%= partition['RootOnly']-%><% end -%>
<% if partition['SelectTypeParameters'] != nil -%> SelectTypeParameters=<%= partition['SelectTypeParameters']-%><% end -%>
<% if partition['Shared'] != nil -%> Shared=<%= partition['Shared']-%><% end -%>
<% if partition['State'] != nil -%> State=<%= partition['State']-%><% end -%>

<% end %>

<% @nodes.values.each do |node| -%>
<% if node['NodeName'] == node['NodeHostName'] or node['NodeHostName'] == nil -%>
<% if node['NodeName'] != nil -%>NodeName=<%= node['NodeName']-%><% end -%>
<% if node['NodeHostName'] != nil -%> NodeHostName=<%= node['NodeHostName']-%><% end -%>
<% if node['NodeAddr'] != nil -%> NodeAddr=<%= node['NodeAddr']-%><% end -%>
<% if node['CPUs'] != nil -%> CPUs=<%= node['CPUs']-%><% end -%>
<% if node['Sockets'] != nil -%> Sockets=<%= node['Sockets']-%><% end -%>
<% if node['ThreadsPerCore'] != nil -%> ThreadsPerCore=<%= node['ThreadsPerCore']-%><% end -%>
<% if node['RealMemory'] != nil -%> RealMemory=<%= node['RealMemory']-%><% end -%>
<% if node['TmpDisk'] != nil -%> TmpDisk=<%= node['TmpDisk']-%><% end -%>
<% if node['Boards'] != nil -%> Boards=<%= node['Boards']-%><% end -%>
<% if node['SocketsPerBoard'] != nil -%> SocketsPerBoard=<%= node['SocketsPerBoard']-%><% end -%>
<% if node['Port'] != nil -%> Port=<%= node['Port']-%><% end -%>
<% if node['CoresPerSocket'] != nil -%> CoresPerSocket=<%= node['CoresPerSocket']-%><% end -%>
<% if node['Weight'] != nil -%> Weight=<%= node['Weight']-%><% end -%>
<% if node['Gres'] != nil -%> Gres=<%= node['Gres'].join(",")-%><% end -%>
<% if node['State'] != nil -%> State=<%= node['State']-%><% end -%>
<% if node['Feature'] != nil -%> Feature=<%= node['Feature'].join(",")-%><% end -%>

<% end -%><% end %>

<% @nodes.values.each do |node| -%>
<% if node['NodeHostName'] != nil and node['NodeName'] != node['NodeHostName'] -%>
<% if node['NodeName'] != nil -%>NodeName=<%= node['NodeName']-%><% end -%>
<% if node['NodeHostName'] != nil -%> NodeHostName=<%= node['NodeHostName']-%><% end -%>
<% if node['NodeAddr'] != nil -%> NodeAddr=<%= node['NodeAddr']-%><% end -%>
<% if node['CPUs'] != nil -%> CPUs=<%= node['CPUs']-%><% end -%>
<% if node['Sockets'] != nil -%> Sockets=<%= node['Sockets']-%><% end -%>
<% if node['ThreadsPerCore'] != nil -%> ThreadsPerCore=<%= node['ThreadsPerCore']-%><% end -%>
<% if node['RealMemory'] != nil -%> RealMemory=<%= node['RealMemory']-%><% end -%>
<% if node['TmpDisk'] != nil -%> TmpDisk=<%= node['TmpDisk']-%><% end -%>
<% if node['Boards'] != nil -%> Boards=<%= node['Boards']-%><% end -%>
<% if node['SocketsPerBoard'] != nil -%> SocketsPerBoard=<%= node['SocketsPerBoard']-%><% end -%>
<% if node['Port'] != nil -%> Port=<%= node['Port']-%><% end -%>
<% if node['CoresPerSocket'] != nil -%> CoresPerSocket=<%= node['CoresPerSocket']-%><% end -%>
<% if node['Weight'] != nil -%> Weight=<%= node['Weight']-%><% end -%>
<% if node['Gres'] != nil -%> Gres=<%= node['Gres'].join(",")-%><% end -%>
<% if node['State'] != nil -%> State=<%= node['State']-%><% end -%>
<% if node['Feature'] != nil -%> Feature=<%= node['Feature'].join(",")-%><% end -%>

<% end -%><% end %>

